name: Deploy to GCP Storage

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  GCS_BUCKET: simple-secret-santa.com
  LOCAL_ARTIFACT_PATH: index.html
  GCS_DESTINATION_PATH: index.html

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        
      - name: Authentification GCP
        id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          # Explicite sur le format du jeton
          token_format: 'access_token' 
          access_token_scopes: 'https://www.googleapis.com/auth/cloud-platform'
          # Ces options sont par d√©faut, mais les garder s'assure que l'√©tape suivante peut les lire
          create_credentials_file: true
          export_environment_variables: true

      # 2. ‚öôÔ∏è SETUP GCLOUD (Pour s'assurer que gsutil est pr√™t)
      - name: Configuration de gcloud et gsutil
        uses: google-github-actions/setup-gcloud@v2
        with:
          # Vous n'avez pas besoin de project_id car il est souvent d√©duit 
          # √† partir des credentials g√©n√©r√©s par l'√©tape 'auth'.
          # Nous nous assurons juste que gsutil est l√†.
          install_components: 'gsutil'

      # 3. üì§ UPLOAD GCS
      - name: Upload du fichier vers GCS
        run: |
          LOCAL_FILE="${{ env.LOCAL_ARTIFACT_PATH }}" 
          GCS_URI="gs://${{ env.GCS_BUCKET }}/${{ env.GCS_DESTINATION_PATH }}"

          echo "D√©but de l'upload de ${LOCAL_FILE} vers ${GCS_URI}"
          # gsutil utilise d√©sormais les credentials inject√©s dans l'environnement
          gsutil cp "${LOCAL_FILE}" "${GCS_URI}" 
          echo "Fichier upload√© avec succ√®s."
